<head>
    <style>
        body { margin: 0; }
        #monthDisplay {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 5px;
        }
        #controlButton {
            position: absolute;
            top: 10px;
            left: 55%;
            transform: translateX(-50%);
            color: white;
            font-size: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        #heading {
            position: absolute;
            top: 10px;
            left: 30%;
            color: white;
            font-size: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 5px;
        }
        /* #globeViz {
            margin-top: 60px; /* Adjust this value to move the globe down
        } */
    </style>
    <meta charset="UTF-8">
    <script src="//unpkg.com/d3"></script>
    <script src="//unpkg.com/d3-dsv"></script>
    <script src="//unpkg.com/globe.gl"></script>
    <!--<script src="../../dist/globe.gl.js"></script>-->
</head>

<body>
  <div id="globeViz"></div>
  <div id="heading"> NO2 monthly concentration µg/m³</div>
  <div id="monthDisplay"> January</div>
  <div id="controlButton" onclick="toggleAnimation()">Pause</div>

  <script>
    const weightColor = d3.scaleSequentialSqrt(d3.interpolateYlOrRd)
      .domain([0, 10]);

    const getTooltip = d => `
      <div style="text-align: center">
        <div><b>${d.points[0].station}</b></div>

        <div>NO2: <em>${d.points[0].currentValue.toFixed(2)}</em></div>
      </div>
    `;

    const world = Globe()
      (document.getElementById('globeViz'))
    //   .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
      .globeImageUrl('//unpkg.com/three-globe/example/img/earth-dark.jpg')
      .bumpImageUrl('//unpkg.com/three-globe/example/img/earth-topology.png')
      .backgroundImageUrl('//unpkg.com/three-globe/example/img/night-sky.png')
      .hexBinPointWeight(d => d.currentValue)
      .hexAltitude(d => d.sumWeight * 6e-2)
      .hexBinResolution(4)
      .hexTopColor(d => weightColor(d.sumWeight))
      .hexSideColor(d => weightColor(d.sumWeight))
      .hexBinMerge(false)
      .enablePointerInteraction(true) // Enable pointer interaction for tooltips
      .hexBinPointLat(d => d.lat)
      .hexBinPointLng(d => d.lng)
      .hexLabel(getTooltip); // Use getTooltip for hex labels

    fetch('./datasets/no2_monthly.json').then(res => res.json())
      .then(data => {
        let currentIndex = 0;
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const parsedData = data.map(({ lat, lon, station, values }) => ({ lat: +lat, lng: +lon, station, values, currentValue: values[0] }));
        world.hexBinPointsData(parsedData);

        // Function to update the data
        const updateData = () => {
          parsedData.forEach(d => {
            d.currentValue = d.values[currentIndex % d.values.length];
          });
          world.hexBinPointsData(parsedData);

          // Update the month display
          document.getElementById('monthDisplay').innerText = months[currentIndex % months.length];

          currentIndex++;
        };
        // Start the animation
        const startAnimation = () => {
                intervalId = setInterval(updateData, 2000);
                };

                // Stop the animation
                const stopAnimation = () => {
                clearInterval(intervalId);
                };

                // Toggle animation state
                window.toggleAnimation = () => {
                const controlButton = document.getElementById('controlButton');
                if (intervalId) {
                    stopAnimation();
                    controlButton.innerText = 'Play';
                    intervalId = null;
                } else {
                    startAnimation();
                    controlButton.innerText = 'Pause';
                }
                };

                // Start the animation initially
                startAnimation();

        // Add labels for station names
    //     const labelsData = parsedData.map(d => ({
    //       lat: d.lat,
    //       lng: d.lng,
    //       text: d.station,
    //       altitude: d.values[0] * 6e-2 + 0.01 // Slightly higher than the hexagon
    //     }));
    //     world.labelsData(labelsData)
    //       .labelLat(d => d.lat)
    //       .labelLng(d => d.lng)
    //       .labelText(d => d.text)
    //       .labelSize(0.5)
    //       .labelColor(() => 'white')
    //       .labelResolution(2)
    //       .labelAltitude(d => d.altitude); // Set the label altitude
      });

    // Add auto-rotation
    world.controls().autoRotate = true;
    world.controls().autoRotateSpeed = 0.0;
     // Center the globe on Europe
     world.pointOfView({ lat: 30, lng: 8, altitude: 1.5 });
  </script>
</body>